<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Wilddog 增删改/排序</title>
</head>
<body>
	<div class="container">
		<div class="ade">
			<h2>增删改</h2>
			<p><input type="text" id="content" placeholder="输入内容"><button id="btn">添加</button><button id="delBtn">删除</button></p>
			<ul id="list"></ul>
		</div>
		<div class="sort">
			<h2>排序/查询</h2>
			<p>将测试数据 key 按照数据节点名称排序</p>
			<p><label for="searchContent">查询名字：</label><input type="text" id="searchContent"><button id="searchBtn">查询</button></p>
			<div class="keyBox"></div>
			<p>将测试数据 val 按照数据节点名称排序</p>
			<div class="valBox"></div>
		</div>
	</div>
	<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://cdn.wilddog.com/js/client/current/wilddog.js" ></script>

	<script type="text/javascript">
		var 
		ref      = new Wilddog("https://wild-boar-74772.wilddogio.com"),
		refUser  = new Wilddog('https://wild-boar-74772.wilddogio.com/user'),
		refTest  = new Wilddog('https://wild-boar-74772.wilddogio.com/test'),
		refVal   = new Wilddog('https://wild-boar-74772.wilddogio.com/val/scores'),
		refAdd   = new Wilddog("https://wild-boar-74772.wilddogio.com/add"),
		oBtn     = $('#btn'),
		oContent = $('#content');

		//加载所有数据
		refAdd.on('child_added', function(titleId) {
			var id = titleId.key();

			//获取数据值
			refAdd.child(id + '/title').on('value', function(titleValue) {
				oTitleVal = titleValue.val();
			});

			//将数据插入 Demo
			$('#list').prepend('<li><input id="'+ id +'" type="checkbox" /> <span data-id="'+ id +'">'+ oTitleVal +'</span><button class="edit">修改</button></li>');
		});

		//设置（写入）测试数据
		var 
		oRef    = ref.child('test'),
		oRefVal = ref.child('val');

		oRef.set({
		  "l": {
		    "height" : 1,
		    "length" : 1,
		    "weight": 5000
		  },
		  "s": {
		    "height" : 2,
		    "length" : 2,
		    "weight" : 2500
		  },
		  "a": {
		    "height" : 3,
		    "length" : 3,
		    "weight" : 1500
		  },
		  "d": {
		    "height" : 4,
		    "length" : 4,
		    "weight" : 3500
		  }
		});

		oRefVal.set({
		  "scores": {
		    "bruhathkayosaurus" : 55,
		    "lambeosaurus" : 21,
		    "linhenykus" : 80,
		    "pterodactyl" : 93,
		    "stegosaurus" : 5,
		    "triceratops" : 22
		  }
		});

		/* 数据排序 */

		//将测试数据 key 按照数据节点名称排序
		var testKey = function() {
			refTest.orderByKey().on('child_added', function(t) {
				$('.keyBox').append('<p>' + t.key() + '</p>');
				// console.log(t.key());
			});	
		};
		
		testKey();

		//将测试数据 val 按照数据节点的值排序
		refVal.orderByValue().on('value', function(t) {
			t.forEach(function(data) {
				$('.valBox').append('<p>' + data.key() + ':' + data.val() + '</p>');
				// console.log(data.key() + ':' + data.val());
			});
		});

		/* 复杂的数据排序/查询 */

		/* limit 查询 */
		//取最后（大）2个值
		refTest.orderByChild('width').limitToLast(2).on('child_added', function(data) {
			console.log(data.key());
		});

		//取最前（小）2个值
		refTest.orderByChild('width').limitToFirst(2).on('child_added', function(data) {
			console.log(data.key());
		});

		//排序后，取最后（大）3个值
		refVal.orderByValue().limitToLast(3).on('value', function(t) {
			t.forEach(function(data) {
				console.log(data.key() + ':' + data.val());
			});
		});

		/* range 查询 */

		//startAt()
		refTest.orderByChild('height').startAt(4).on('child_added', function(data) {
			console.log('查询 height，4米以上的：' + data.key());	//查询 height，4米以上的，只有1个，dtegosaurus
		});

		//endAt()
		refTest.orderByKey().endAt('lambeosaurus').on('child_added', function(data) {
			//查询按照字母排序，所有名字排在 lambeosaurus 之前的。（包括自己（lambeosaurus），还有2个 ategosaurus，dtegosaurus）
			console.log('查询按照字母排序，所有名字排在 lambeosaurus 之前的：' + data.key());	
		});

		$('#searchBtn').on('click', function() {
			var oSearchContent = $('#searchContent').val();

			//综合使用：startAt() 与 endAt() 来限定一个范围，查询出所有名字以字母“b”开头的
			refTest.orderByKey().startAt(oSearchContent).endAt(oSearchContent+'~').on('child_added', function(data) {

				var oData = data.key();

				if (oSearchContent.length === 0) {
					$('.keyBox').empty();
				} else {
					console.log(oData);
					$('.keyBox').html(oData);
				}
			});
		});
		

		//equalTo() 可以进行精准查询
		refTest.orderByChild('weight').equalTo(1500).on('child_added', function(data) {
			console.info('精准查询：' + data.key());	//精准查询，weight 为 1500 的。
		});


		//添加新数据
		oBtn.on('click', function() {
			var oContentVal = oContent.val();
			refAdd.push({title: oContentVal});
			//清空Inpuit
			oContent.val('');
		});

		//Enter 事件新增数据
		oContent.on('keypress', function(event) {
			if (event.keyCode == '13') {
				$('#btn').trigger('click');
			}
		});

		//删除数据
		$('#delBtn').on('click', function() {
			$('input:checked').each(function(index, el) {
				var id = $(el).prop('id');
				refAdd.child(id).remove();
				$(el).parent().remove();
			});
		});

		//删除数据监听
		refAdd.on('child_removed', function(titleRemove) {
			var oTitleRemove = titleRemove.val();
			console.log('删除了内容：' + oTitleRemove.title);
		});

		//修改数据
		$('.container').on('click', '.edit', function() {
			var 
			oThis    = $(this).prev(),
			oEditId  = oThis.attr('data-id'),
			oEditVal = oThis.text(),
			oEdit    = prompt('输入要修改内容', oEditVal);

			if (oEdit.length === 0) {
				refAdd.child(oEditId).remove();
				$(this).parent().remove();
			} else {
				refAdd.child(oEditId).update({'title': oEdit});
				oThis.text(oEdit);	
			}
		});

		//修改数据监听
		refAdd.on('child_changed', function(titleChang) {
			var oTitleChang = titleChang.val();
			console.log('修改了内容：' + oTitleChang.title);
		});
	</script>
</body>
</html>